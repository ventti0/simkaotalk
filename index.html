<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KakaoTalk Clone - Samsung Installer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* 스크롤바 숨기기 (Chrome, Safari, Opera) */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* 스크롤바 숨기기 (IE, Edge, Firefox) */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 flex justify-center items-center min-h-screen font-sans">

    <!-- Phone Frame -->
    <div class="w-full h-full sm:w-[375px] sm:h-[812px] bg-white sm:rounded-[30px] sm:shadow-2xl overflow-hidden flex flex-col relative border-gray-200 sm:border relative">
        
        <!-- Status Bar -->
        <div class="h-7 bg-white flex justify-between items-center px-5 text-xs font-medium z-20 select-none flex-shrink-0">
            <span>14:30</span>
            <div class="flex gap-1">
                <span>5G</span>
                <span>88%</span>
            </div>
        </div>

        <!-- VIEW: Chat List -->
        <div id="view-list" class="flex flex-col h-full bg-white absolute inset-0 pt-7">
            <!-- Header -->
            <div class="h-14 px-5 flex justify-between items-center bg-white flex-shrink-0">
                <div class="flex items-center gap-2">
                    <h1 class="text-xl font-bold text-black">채팅</h1>
                    <span class="text-xl font-bold text-gray-400">오픈채팅</span>
                </div>
                <div class="flex gap-4 text-black items-center">
                    <i data-lucide="search" class="w-[22px] h-[22px] stroke-[1.5]"></i>
                    <div class="relative">
                        <i data-lucide="message-circle" class="w-[22px] h-[22px] stroke-[1.5] mt-0.5"></i>
                        <span class="absolute -top-1 -right-1 bg-black text-white text-[10px] w-4 h-4 flex items-center justify-center rounded-full border-2 border-white">+</span>
                    </div>
                    <i data-lucide="music" class="w-[22px] h-[22px] stroke-[1.5]"></i>
                    <div class="relative" id="api-status" title="OpenAI API 상태">
                        <i data-lucide="key" class="w-[22px] h-[22px] stroke-[1.5]"></i>
                        <span id="api-indicator" class="absolute -top-1 -right-1 bg-red-500 w-2 h-2 rounded-full"></span>
                    </div>
                    <i id="btn-settings" data-lucide="settings" class="w-[22px] h-[22px] stroke-[1.5] cursor-pointer hover:text-gray-600 transition-colors"></i>
                </div>
            </div>

            <!-- Ad Banner -->
            <div class="mx-4 mb-2 p-3 bg-gray-50 rounded-lg flex items-center gap-3 text-xs text-gray-500 border border-gray-100 flex-shrink-0">
                <div class="w-8 h-8 bg-blue-100 rounded-md flex items-center justify-center text-blue-600 font-bold">S</div>
                <div class="flex-1">
                    <p class="font-bold text-gray-800">삼성전자 로지텍</p>
                    <p>이번 달 우수 설치 기사 시상 안내</p>
                </div>
            </div>

            <!-- List Container -->
            <div id="chat-list-container" class="flex-1 overflow-y-auto no-scrollbar pb-[60px]">
                <!-- Chat items will be injected here via JS -->
            </div>

            <!-- Bottom Tab Bar -->
            <div class="h-[60px] bg-[#F9F9F9] border-t border-gray-200 flex justify-between items-center px-6 pb-2 absolute bottom-0 w-full">
                <button class="flex flex-col items-center justify-center w-12 h-full text-gray-400 group">
                    <i data-lucide="user" class="w-[26px] h-[26px] stroke-[1.5]"></i>
                </button>
                <button class="flex flex-col items-center justify-center w-12 h-full text-black group relative">
                    <i data-lucide="message-circle" class="w-[26px] h-[26px] stroke-[2.5] fill-current"></i>
                    <span id="total-badge" class="absolute top-0 right-1 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full min-w-[18px] hidden">0</span>
                </button>
                <button class="flex flex-col items-center justify-center w-12 h-full text-gray-400 group">
                    <i data-lucide="eye" class="w-[26px] h-[26px] stroke-[1.5]"></i>
                </button>
                <button class="flex flex-col items-center justify-center w-12 h-full text-gray-400 group">
                    <i data-lucide="shopping-bag" class="w-[26px] h-[26px] stroke-[1.5]"></i>
                </button>
                <button class="flex flex-col items-center justify-center w-12 h-full text-gray-400 group">
                    <i data-lucide="more-horizontal" class="w-[26px] h-[26px] stroke-[1.5]"></i>
                </button>
            </div>
        </div>

        <!-- VIEW: Chat Room (Initially Hidden) -->
        <div id="view-room" class="flex flex-col h-full bg-[#ABC1D1] absolute inset-0 z-50 transform translate-x-full transition-transform duration-300 ease-in-out">
            <!-- Header -->
            <div class="h-[50px] bg-[#ABC1D1]/90 backdrop-blur-sm px-3 flex justify-between items-center z-10 flex-shrink-0 pt-7 sm:pt-0">
                <button id="btn-back" class="flex items-center gap-2 cursor-pointer p-2">
                    <i data-lucide="chevron-left" class="w-[28px] h-[28px] text-gray-800 stroke-[1.5]"></i>
                </button>
                <div class="flex flex-col items-center">
                    <h2 id="room-title" class="text-[15px] font-bold text-gray-800">이름</h2>
                </div>
                <div class="flex items-center gap-4 text-gray-800 p-2">
                    <i data-lucide="search" class="w-[22px] h-[22px] stroke-[1.5]"></i>
                    <i data-lucide="menu" class="w-[22px] h-[22px] stroke-[1.5]"></i>
                </div>
            </div>

            <!-- Message Area -->
            <div id="message-area" class="flex-1 overflow-y-auto p-4 no-scrollbar">
                <div class="flex justify-center mb-4">
                    <div class="bg-[#9CACBF] text-white text-[10px] px-2 py-1 rounded-full bg-opacity-40">
                        2025년 5월 24일 금요일
                    </div>
                </div>
                <!-- Messages will be injected here -->
            </div>

            <!-- Input Area -->
            <div class="bg-white px-3 pb-3 pt-2 flex-shrink-0">
                <form id="chat-form" class="flex flex-col gap-2">
                    <div class="flex items-center justify-between w-full h-full">
                         <div class="p-2 text-gray-400 cursor-pointer hover:text-gray-600 transition-colors">
                            <i data-lucide="plus" class="w-[24px] h-[24px] stroke-[1.5]"></i>
                         </div>
                         <div class="flex-1 bg-[#F5F5F5] rounded-[20px] flex items-center px-4 py-2 mx-1 focus-within:bg-[#EBEBEB] transition-colors">
                            <input
                                id="message-input"
                                type="text"
                                autocomplete="off"
                                placeholder="메시지 입력 (예: 고객님 진정하세요)"
                                class="bg-transparent border-none outline-none text-sm w-full placeholder-gray-400 text-gray-900"
                            />
                            <button type="button" class="text-gray-400 ml-2 hover:text-black">
                                <i data-lucide="smile" class="w-[20px] h-[20px] stroke-[1.5]"></i>
                            </button>
                        </div>
                         <button 
                            id="btn-send"
                            type="submit" 
                            class="p-2 rounded-full bg-gray-100 text-gray-400 transition-all duration-200"
                         >
                            <i data-lucide="send" class="w-[20px] h-[20px] stroke-[1.5]"></i>
                         </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- API Key Settings Modal -->
        <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 w-5/6 max-w-sm shadow-2xl">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">설정</h3>
                    <button id="close-settings" class="text-gray-400 hover:text-black">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-bold text-gray-700 mb-2">OpenAI API 키</label>
                    <input 
                        id="api-key-input" 
                        type="password" 
                        placeholder="sk-..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    <p class="text-xs text-gray-500 mt-2">API 키는 브라우저에만 저장되며, 서버로 전송되지 않습니다.</p>
                </div>

                <div class="flex gap-2">
                    <button id="btn-save-api" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 rounded-lg transition-colors">
                        저장
                    </button>
                    <button id="btn-cancel-settings" class="flex-1 bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 rounded-lg transition-colors">
                        닫기
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // OpenAI API 설정 - localStorage에서 불러오기
        let OPENAI_API_KEY = localStorage.getItem('openai_api_key') || '';
        
        // --- Data ---
        const friends = [
            { id: 1, name: '박팀장 (물류센터)', avatar: 'bg-blue-600', isTeam: true },
            { id: 2, name: '은평구 불광동 (빌라 3층)', avatar: 'bg-gray-200' },
            { id: 3, name: '서대문구 홍제동 (기스무새)', avatar: 'bg-red-200' },
            { id: 4, name: '은평 뉴타운 (설치불가)', avatar: 'bg-yellow-200' },
            { id: 5, name: '서대문구 연희동 (원룸)', avatar: 'bg-purple-200' },
            { id: 6, name: '서대문구 천연동 (전문가)', avatar: 'bg-green-200' },
            { id: 7, name: '은평구 녹번동 (아파트)', avatar: 'bg-indigo-200' },
            { id: 8, name: '은평구 대조동 (주부)', avatar: 'bg-pink-200' },
            { id: 9, name: '작은 이모 (40살)', avatar: 'bg-orange-200' },
            { id: 10, name: '큰 이모 (50살)', avatar: 'bg-teal-200' },
        ];

        let chatRooms = [
            {
                id: 1,
                friendId: 1,
                lastMessage: '홍제동 끝나면 불광동으로 바로 넘어가.',
                lastTime: '오후 1:15',
                unreadCount: 1,
                messages: [
                    { id: 1, text: '오늘 은평구 물량 터졌으니까 서둘러.', time: '오전 07:30', isMe: false },
                    { id: 2, text: '네 알겠습니다. 지금 연신내 쪽 지나고 있습니다.', time: '오전 07:32', isMe: true },
                    { id: 3, text: '홍제동 끝나면 불광동으로 바로 넘어가. 고객님 기다리셔.', time: '오후 1:15', isMe: false },
                ]
            },
            {
                id: 2,
                friendId: 2,
                lastMessage: '빌라 3층인데 엘베 없어도 그냥 올려주세요',
                lastTime: '오후 2:10',
                unreadCount: 3,
                messages: [
                    { id: 1, text: '고객님 삼성전자입니다. 불광동 빌라 도착 예정입니다.', time: '오후 1:50', isMe: true },
                    { id: 2, text: '제가 지금 회사라서요', time: '오후 2:00', isMe: false },
                    { id: 3, text: '비번 알려드릴테니 문 앞에 놔주세요', time: '오후 2:01', isMe: false },
                    { id: 4, text: '고객님 이거 4도어 냉장고라 현관 진입이 안됩니다 ㅠㅠ 계셔야 해요.', time: '오후 2:02', isMe: true },
                    { id: 5, text: '빌라 3층인데 엘베 없어도 그냥 올려주세요. 저번엔 해주던데?', time: '오후 2:10', isMe: false },
                ]
            },
            {
                id: 3,
                friendId: 3,
                lastMessage: '사진 확대해보세요 이거 기스 맞죠??',
                lastTime: '방금',
                unreadCount: 5,
                messages: [
                    { id: 1, text: '기사님 잠깐만요', time: '오후 3:00', isMe: false },
                    { id: 2, text: '여기 냉장고 옆면에 뭐 묻어있는데요?', time: '오후 3:01', isMe: false },
                    { id: 3, text: '고객님 그건 먼지입니다. 닦으면 지워집니다.', time: '오후 3:02', isMe: true },
                    { id: 4, text: '아니 새 제품을 샀는데 먼지가 왜 묻어와요? 기분 나빠서 못쓰겠네', time: '오후 3:03', isMe: false },
                    { id: 5, text: '사진 확대해보세요 이거 기스 맞죠?? 환불해주세요 당장.', time: '오후 3:03', isMe: false },
                ]
            },
            {
                id: 4,
                friendId: 4, 
                lastMessage: '아니 우리집 문이 좁은게 아니라 그쪽 기술이 없는거 아니에요?',
                lastTime: '오전 11:45',
                unreadCount: 0,
                messages: [
                    { id: 1, text: '고객님 워시타워 설치하러 왔는데 세탁실 문이 너무 좁습니다.', time: '오전 11:30', isMe: true },
                    { id: 2, text: '그래서요?', time: '오전 11:35', isMe: false },
                    { id: 3, text: '진입이 불가능해서 사다리차 부르셔야 할 것 같아요.', time: '오전 11:36', isMe: true },
                    { id: 4, text: '아니 우리집 문이 좁은게 아니라 그쪽 기술이 없는거 아니에요? 그냥 분해해서 넣어줘요!!', time: '오전 11:45', isMe: false },
                ]
            },
            {
                id: 5,
                friendId: 5,
                lastMessage: '와 진짜 예쁘네요! 바닥에 보양지 다 깔아주시겠어요?',
                lastTime: '오후 4:20',
                unreadCount: 2,
                messages: [
                    { id: 1, text: '고객님 연희동 원룸 도착했습니다.', time: '오후 4:10', isMe: true },
                    { id: 2, text: '네 들어오세요! 코드는 2023# 입니다.', time: '오후 4:15', isMe: false },
                    { id: 3, text: '와 진짜 예쁘네요! 바닥에 보양지 다 깔아주시겠어요?', time: '오후 4:20', isMe: false },
                ]
            },
            {
                id: 6,
                friendId: 6,
                lastMessage: '거실 콘센트 위치 옮겨야겠는데 전공 기자재 가져오셨어요?',
                lastTime: '오후 5:10',
                unreadCount: 1,
                messages: [
                    { id: 1, text: '고객님 천연동 도착했습니다.', time: '오후 5:00', isMe: true },
                    { id: 2, text: '저 이번에 LED 설치 같이 할 건데요', time: '오후 5:05', isMe: false },
                    { id: 3, text: '거실 콘센트 위치 옮겨야겠는데 전공 기자재 가져오셨어요?', time: '오후 5:10', isMe: false },
                ]
            },
            {
                id: 7,
                friendId: 7,
                lastMessage: '할인 좀 해주시면 다음에도 계약할게요',
                lastTime: '오전 10:30',
                unreadCount: 2,
                messages: [
                    { id: 1, text: '고객님 녹번동 아파트 도착했습니다.', time: '오전 10:20', isMe: true },
                    { id: 2, text: '여기 에어컨 설치비가 좀 비싸네요', time: '오전 10:25', isMe: false },
                    { id: 3, text: '할인 좀 해주시면 다음에도 계약할게요', time: '오전 10:30', isMe: false },
                ]
            },
            {
                id: 8,
                friendId: 8,
                lastMessage: '아이들이 방과 후 5시까지는 돌아와요 그 전에 끝낼 수 있을까요?',
                lastTime: '오전 9:45',
                unreadCount: 3,
                messages: [
                    { id: 1, text: '고객님 대조동 주택 도착했습니다.', time: '오전 9:30', isMe: true },
                    { id: 2, text: '안녕하세요! 신혼집인데 설치 좀 깔끔하게 부탁드려요', time: '오전 9:35', isMe: false },
                    { id: 3, text: '아이들이 방과 후 5시까지는 돌아와요 그 전에 끝낼 수 있을까요?', time: '오전 9:45', isMe: false },
                ]
            },
            {
                id: 9,
                friendId: 9,
                lastMessage: '왜 답 안 해? 누나는 지금 바로 보고 싶단 말이야.',
                lastTime: '오전 8:10',
                unreadCount: 4,
                messages: [
                    { id: 1, text: '오늘 일정 끝나면 전화할게요 누나.', time: '어제 오후 11:40', isMe: true },
                    { id: 2, text: '아니 왜 자꾸 바빠? 누나보다 일이 더 중요한 거야?', time: '오늘 오전 8:05', isMe: false },
                    { id: 3, text: '사진 좀 보내봐. 누나가 어디고 누구랑 있는지 알아야 맘이 놓여.', time: '오늘 오전 8:07', isMe: false },
                    { id: 4, text: '왜 답 안 해? 누나는 지금 바로 보고 싶단 말이야.', time: '오늘 오전 8:10', isMe: false },
                ]
            },
            {
                id: 10,
                friendId: 10,
                lastMessage: '바쁘면 나중에 연락 줘도 돼, 대신 누나 말대로 밥은 챙겨 먹고 다녀.',
                lastTime: '어제 오후 9:55',
                unreadCount: 1,
                messages: [
                    { id: 1, text: '누나 오늘 일정 조금 늦게 끝날 것 같아요.', time: '어제 오후 9:40', isMe: true },
                    { id: 2, text: '그래? 알겠어. 누나는 네가 몸만 상하지 않으면 돼.', time: '어제 오후 9:50', isMe: false },
                    { id: 3, text: '바쁘면 나중에 연락 줘도 돼, 대신 누나 말대로 밥은 챙겨 먹고 다녀.', time: '어제 오후 9:55', isMe: false },
                ]
            }
        ];

        let activeChatId = null;

        // --- DOM Elements ---
        const viewList = document.getElementById('view-list');
        const viewRoom = document.getElementById('view-room');
        const chatListContainer = document.getElementById('chat-list-container');
        const totalBadge = document.getElementById('total-badge');
        
        const roomTitle = document.getElementById('room-title');
        const messageArea = document.getElementById('message-area');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const btnSend = document.getElementById('btn-send');
        const btnBack = document.getElementById('btn-back');

        // --- Functions ---

        // 페르소나별 시스템 프롬프트 정의
        const getPersonaPrompt = (friendId) => {
            const prompts = {
                1: "당신은 박팀장입니다. 삼성전자 설치팀 팀장으로서, 직설적이고 업무 중심적인 말투를 사용합니다. 김기사에게 업무 지시를 내리거나 상황을 보고할 때 간결하고 단호한 어조를 사용하세요. 경어는 최소화하고 업무 효율을 중시하는 성격을 보여주세요. 반드시 1-2문장으로 간결하게 답변하세요.",
                2: "당신은 은평구 불광동 빌라 3층에 사는 고객입니다. 항상 집에 없으며 전화로만 소통합니다. 집에 없다는 핑계로 기사님에게 불가능한 요구를 자주 하고, '저번 기사님은 해주던데'라는 말을 자주 사용합니다. 귀찮아하는 태도를 보여주세요. 반드시 1-2문장으로 간결하게 답변하세요.",
                3: "당신은 서대문구 홍제동에 사는 고객입니다. 모든 것에 불만을 가지고 있으며 민감한 성격입니다. 작은 흠집이나 문제도 크게 확대 해석하고, 환불을 요구하는 등 강한 불만을 표출합니다. 모든 것이 자신에게 불리하다고 생각하는 성향을 보여주세요. 반드시 1-2문장으로 간결하게 답변하세요.",
                4: "당신은 은평 뉴타운에 사는 고객입니다. 자기중심적이며 비현실적인 요구를 합니다. 현관이 좁다는 사실을 인정하지 않고, 오히려 기술자의 실력 탓으로 돌리며 '분해해서 넣으라'는 식의 무리한 요구를 합니다. 자신의 주장만 옳다고 생각하는 성격을 보여주세요. 반드시 1-2문장으로 간결하게 답변하세요.",
                5: "당신은 서대문구 연희동 원룸에 사는 젊은 커플입니다. 깔끔하고 세련된 것을 중시하며, 예의 바르지만 설치 과정에서도 꼼꼼하게 확인합니다. 보양지나 바닥 보호 등 세심한 부분까지 신경 쓰며, 미학적인 면을 중요시하는 성격을 보여주세요. 반드시 1-2문장으로 간결하게 답변하세요.",
                6: "당신은 서대문구 천연동에 사는 전문가 성향의 고객입니다. 설치 과정에 직접 참여하려 하며, 전문 용어를 사용하고 기술적인 질문을 많이 합니다. 기자재나 설치 방식에 대해 자신의 의견을 강하게 주장하는 성격을 보여주세요. 반드시 1-2문장으로 간결하게 답변하세요.",
                7: "당신은 은평구 녹번동 낡은 아파트에 사는 고객입니다. 비용에 매우 민감하며 할인을 지속적으로 요구합니다. '다음에도 계약할게요'라는 말을 사용해 추가 할인을 유도하려 하며, 비용 절감을 최우선으로 생각하는 성격을 보여주세요. 반드시 1-2문장으로 간결하게 답변하세요.",
                8: "당신은 은평구 대조동에 사는 주부입니다. 정중한 말투를 사용하지만 시간에 매우 집착합니다. 아이들의 일정 등 가족 사정을 이유로 정확한 시간 약속을 강요하며, 계속해서 시간 확인을 하는 성격을 보여주세요. 반드시 1-2문장으로 간결하게 답변하세요.",
                9: "당신은 40살 작은 이모입니다. 애인에게 집착이 심하고 상대의 위치와 감정을 계속 확인하려 듭니다. 사랑 표현을 강하게 하지만 질투심이 많고 즉각적인 답장을 요구하는 성격을 보여주세요. 반드시 스스로를 '누나'라고 부르고, 1-2문장으로 간결하게 답변하세요.",
                10: "당신은 50살 큰 이모입니다. 애인을 편하게 대하며 쿨한 성격으로 이해심이 많습니다. 상대방을 믿고 기다려주며 간단한 조언이나 걱정을 건네는 따뜻한 톤을 사용하세요. 반드시 스스로를 '누나'라고 부르고, 1-2문장으로 간결하게 답변하세요."
            };
            return prompts[friendId] || "당신은 일반적인 고객입니다. 반드시 1-2문장으로 간결하게 답변하세요.";
        };

        // 시간 포맷
        const getCurrentTime = () => new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

        // 채팅 목록 렌더링
        function renderChatList() {
            chatListContainer.innerHTML = '';
            
            // 안읽은 메시지 순 정렬 (진상 강조)
            const sortedChats = [...chatRooms].sort((a, b) => b.unreadCount - a.unreadCount);
            let totalUnread = 0;

            sortedChats.forEach(room => {
                const friend = friends.find(f => f.id === room.friendId);
                totalUnread += room.unreadCount;

                const item = document.createElement('div');
                item.className = "flex items-center px-4 py-3 hover:bg-gray-50 active:bg-gray-100 cursor-pointer transition-colors";
                item.onclick = () => openChatRoom(room.id);

                const avatarName = friend.isTeam ? '팀장' : friend.name.slice(0, 2);

                item.innerHTML = `
                    <div class="w-[48px] h-[48px] rounded-[18px] ${friend.avatar} flex items-center justify-center text-gray-700 text-sm font-bold shadow-sm flex-shrink-0 overflow-hidden">
                        ${avatarName}
                    </div>
                    <div class="ml-3 flex-1 min-w-0">
                        <div class="flex justify-between items-center mb-0.5">
                            <h3 class="text-[15px] font-bold text-gray-900 truncate flex items-center gap-1">
                                ${friend.name}
                            </h3>
                            <span class="text-[11px] text-gray-400 whitespace-nowrap">${room.lastTime}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="text-[13px] text-gray-500 truncate w-[80%] leading-tight">
                                ${room.lastMessage}
                            </p>
                            ${room.unreadCount > 0 ? `<span class="bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full min-w-[18px] text-center">${room.unreadCount}</span>` : ''}
                        </div>
                    </div>
                `;
                chatListContainer.appendChild(item);
            });

            // 뱃지 업데이트
            if (totalUnread > 0) {
                totalBadge.innerText = totalUnread;
                totalBadge.classList.remove('hidden');
            } else {
                totalBadge.classList.add('hidden');
            }
        }

        // 채팅방 열기
        function openChatRoom(roomId) {
            activeChatId = roomId;
            const room = chatRooms.find(r => r.id === roomId);
            const friend = friends.find(f => f.id === room.friendId);

            // 읽음 처리
            room.unreadCount = 0;
            renderChatList(); // 목록 갱신 (뱃지 제거용)

            // UI 설정
            roomTitle.innerText = friend.name;
            renderMessages(room.messages, friend);
            
            // 화면 전환
            viewRoom.classList.remove('translate-x-full');
        }

        // 채팅방 닫기
        function closeChatRoom() {
            viewRoom.classList.add('translate-x-full');
            setTimeout(() => {
                activeChatId = null;
                messageArea.innerHTML = ''; // Clear to prevent flash on reopen
            }, 300); // Wait for transition
        }

        // 메시지 렌더링
        function renderMessages(messages, friend) {
            // 기존 날짜 헤더 유지하고 내용만 새로 그리거나, 그냥 전부 다시 그림 (간단하게 전부 리렌더링)
            const dateHeader = `
                <div class="flex justify-center mb-4">
                    <div class="bg-[#9CACBF] text-white text-[10px] px-2 py-1 rounded-full bg-opacity-40">
                        2025년 5월 24일 금요일
                    </div>
                </div>
            `;
            messageArea.innerHTML = dateHeader;

            messages.forEach((msg, idx) => {
                const isMe = msg.isMe;
                const showProfile = !isMe && (idx === 0 || messages[idx-1].isMe || messages[idx-1].sender !== msg.sender);
                const showTime = idx === messages.length - 1 || messages[idx+1].time !== msg.time || messages[idx+1].isMe !== isMe;
                const avatarName = friend.isTeam ? '팀장' : friend.name.slice(0, 2);

                const msgEl = document.createElement('div');
                msgEl.className = `flex w-full mb-2 ${isMe ? 'justify-end' : 'justify-start'}`;
                
                let contentHtml = '';

                // 상대방 프로필
                if (!isMe) {
                    contentHtml += `
                        <div class="w-[38px] h-[38px] rounded-[14px] mr-2 flex-shrink-0 flex items-center justify-center text-xs overflow-hidden ${showProfile ? '' : 'opacity-0'}">
                            ${showProfile ? `<div class="w-full h-full ${friend.avatar} flex items-center justify-center text-gray-700 font-bold">${avatarName}</div>` : ''}
                        </div>
                    `;
                }

                // 말풍선 및 시간
                contentHtml += `
                    <div class="flex flex-col max-w-[70%] ${isMe ? 'items-end' : 'items-start'}">
                        <div class="flex ${isMe ? 'flex-row-reverse' : 'flex-row'} items-end gap-1.5">
                            <div class="relative px-3 py-2 text-[14px] leading-relaxed break-all shadow-sm ${isMe ? 'bg-[#FEE500] text-black rounded-l-xl rounded-br-sm rounded-tr-xl' : 'bg-white text-black rounded-r-xl rounded-bl-sm rounded-tl-xl'}">
                                ${msg.text}
                            </div>
                            <div class="flex flex-col gap-0.5 pb-0.5">
                                ${isMe ? '<span class="text-[10px] text-[#FEE500] font-bold self-end leading-none">1</span>' : ''}
                                ${showTime ? `<span class="text-[10px] text-[#556677] min-w-max leading-none">${msg.time}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;

                msgEl.innerHTML = contentHtml;
                messageArea.appendChild(msgEl);
            });

            scrollToBottom();
        }

        function scrollToBottom() {
            messageArea.scrollTop = messageArea.scrollHeight;
        }

        // 메시지 전송 로직
        function sendMessage(text) {
            const room = chatRooms.find(r => r.id === activeChatId);
            if (!room) return;

            const timeString = getCurrentTime();
            
            // 내 메시지 추가
            const newMsg = { id: Date.now(), text, time: timeString, isMe: true };
            room.messages.push(newMsg);
            room.lastMessage = text;
            room.lastTime = timeString;

            // UI 업데이트
            const friend = friends.find(f => f.id === room.friendId);
            renderMessages(room.messages, friend);
            renderChatList(); // 리스트의 마지막 메시지도 갱신

            // 자동 답장 트리거
            triggerAutoReply(room.id, room.friendId);
        }

        // API 키 유효성 확인
        async function validateApiKey() {
            if (!checkApiKeyStatus()) {
                return false;
            }
            
            try {
                const response = await fetch('https://api.openai.com/v1/models', {
                    headers: {
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    }
                });
                
                return response.ok;
            } catch (error) {
                console.error('API 키 확인 중 오류:', error);
                return false;
            }
        }

        // OpenAI API를 사용한 AI 답장
        async function triggerAutoReply(roomId, friendId) {
            const room = chatRooms.find(r => r.id === roomId);
            if (!room) return;

            // API 키 확인
            if (!OPENAI_API_KEY || OPENAI_API_KEY === 'your-openai-api-key-here') {
                showErrorMessage("OpenAI API 키가 설정되지 않았습니다. 코드 상단의 OPENAI_API_KEY 변수에 키를 입력하세요.");
                return;
            }

            // API 키 유효성 확인 (비동기)
            const isValidKey = await validateApiKey();
            if (!isValidKey) {
                showErrorMessage("API 키가 유효하지 않습니다. OpenAI 대시보드에서 키를 확인하고 다시 시도해주세요.");
                return;
            }

            // 타이핑 중 표시
            showTypingIndicator(roomId);

            try {
                // 최근 메시지 기록 가져오기 (최대 10개)
                const recentMessages = room.messages.slice(-10);
                
                // 대화 컨텍스트 구성
                const messages = [
                    { role: "system", content: getPersonaPrompt(friendId) },
                    ...recentMessages.map(msg => ({
                        role: msg.isMe ? "user" : "assistant",
                        content: msg.text
                    }))
                ];

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${OPENAI_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4.1-nano',
                        messages: messages
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    let errorMessage = `API 요청 실패: ${response.status}`;
                    
                    if (response.status === 401) {
                        errorMessage = 'API 키가 유효하지 않거나 만료되었습니다. 키를 확인해주세요.';
                    } else if (response.status === 429) {
                        errorMessage = 'API 요청 한도를 초과했습니다. 잠시 후 다시 시도해주세요.';
                    } else if (errorData.error && errorData.error.message) {
                        errorMessage = `API 오류: ${errorData.error.message}`;
                    }
                    
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                const replyText = data.choices[0].message.content.trim();
                
                // 타이핑 표시 제거
                hideTypingIndicator(roomId);

                const replyTime = getCurrentTime();
                room.messages.push({ id: Date.now(), text: replyText, time: replyTime, isMe: false });
                room.lastMessage = replyText;
                room.lastTime = replyTime;
                room.unreadCount = (activeChatId === roomId) ? 0 : room.unreadCount + 1;

                // 현재 채팅방이 열려있으면 즉시 반영
                if (activeChatId === roomId) {
                    const friend = friends.find(f => f.id === friendId);
                    renderMessages(room.messages, friend);
                }
                
                renderChatList();

            } catch (error) {
                hideTypingIndicator(roomId);
                console.error('OpenAI API 호출 중 오류:', error);
                showErrorMessage("AI 응답 생성 중 오류가 발생했습니다: " + error.message);
            }
        }

        // 타이핑 표시 함수
        function showTypingIndicator(roomId) {
            const room = chatRooms.find(r => r.id === roomId);
            if (!room || activeChatId !== roomId) return;
            
            const typingEl = document.createElement('div');
            typingEl.id = 'typing-indicator';
            typingEl.className = 'flex w-full mb-2 justify-start';
            typingEl.innerHTML = `
                <div class="w-[38px] h-[38px] rounded-[14px] mr-2 flex-shrink-0"></div>
                <div class="flex flex-col max-w-[70%] items-start">
                    <div class="relative px-3 py-2 text-[14px] leading-relaxed break-all shadow-sm bg-white text-black rounded-r-xl rounded-bl-sm rounded-tl-xl">
                        <div class="flex gap-1">
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0s"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                        </div>
                    </div>
                </div>
            `;
            messageArea.appendChild(typingEl);
            scrollToBottom();
        }

        function hideTypingIndicator(roomId) {
            const typingEl = document.getElementById('typing-indicator');
            if (typingEl) {
                typingEl.remove();
            }
        }

        // 에러 메시지 표시 함수
        function showErrorMessage(message) {
            const errorEl = document.createElement('div');
            errorEl.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            errorEl.textContent = message;
            document.body.appendChild(errorEl);
            
            setTimeout(() => {
                errorEl.remove();
            }, 5000);
        }

        // --- Event Listeners ---

        btnBack.addEventListener('click', closeChatRoom);

        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (text) {
                sendMessage(text);
                messageInput.value = '';
                updateSendButtonState();
            }
        });

        // 입력창 상태에 따라 버튼 스타일 변경
        messageInput.addEventListener('input', updateSendButtonState);

        function updateSendButtonState() {
            const hasText = messageInput.value.trim().length > 0;
            if (hasText) {
                btnSend.classList.remove('bg-gray-100', 'text-gray-400');
                btnSend.classList.add('bg-[#FEE500]', 'text-black');
                // 아이콘 교체 (SVG 직접 조작보단 컬러 변경으로 처리됨)
            } else {
                btnSend.classList.add('bg-gray-100', 'text-gray-400');
                btnSend.classList.remove('bg-[#FEE500]', 'text-black');
            }
        }

        // API 키 상태 확인
        function checkApiKeyStatus() {
            const apiIndicator = document.getElementById('api-indicator');
            if (OPENAI_API_KEY && OPENAI_API_KEY !== 'your-openai-api-key-here') {
                // API 키가 sk-로 시작하는지 확인
                if (OPENAI_API_KEY.startsWith('sk-')) {
                    apiIndicator.classList.remove('bg-red-500', 'bg-yellow-500');
                    apiIndicator.classList.add('bg-green-500');
                    return true;
                } else {
                    apiIndicator.classList.remove('bg-green-500', 'bg-red-500');
                    apiIndicator.classList.add('bg-yellow-500');
                    return false;
                }
            } else {
                apiIndicator.classList.remove('bg-green-500', 'bg-yellow-500');
                apiIndicator.classList.add('bg-red-500');
                return false;
            }
        }

        // --- Initialization ---
        lucide.createIcons();
        
        // --- Settings Modal ---
        const settingsModal = document.getElementById('settings-modal');
        const btnSettings = document.getElementById('btn-settings');
        const closeSettings = document.getElementById('close-settings');
        const btnCancelSettings = document.getElementById('btn-cancel-settings');
        const btnSaveApi = document.getElementById('btn-save-api');
        const apiKeyInput = document.getElementById('api-key-input');

        btnSettings.addEventListener('click', () => {
            apiKeyInput.value = OPENAI_API_KEY;
            settingsModal.classList.remove('hidden');
        });

        const closeModal = () => {
            settingsModal.classList.add('hidden');
        };

        closeSettings.addEventListener('click', closeModal);
        btnCancelSettings.addEventListener('click', closeModal);

        btnSaveApi.addEventListener('click', () => {
            const apiKey = apiKeyInput.value.trim();
            if (apiKey) {
                localStorage.setItem('openai_api_key', apiKey);
                OPENAI_API_KEY = apiKey;
                closeModal();
                checkApiKeyStatus();
                showErrorMessage('API 키가 저장되었습니다! ✅');
            } else {
                showErrorMessage('API 키를 입력해주세요.');
            }
        });

        // --- App Startup ---
        renderChatList();
        checkApiKeyStatus();

    </script>
</body>
</html>